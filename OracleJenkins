node('master') {
    // Variables to set
   
 
    stage ('SCM Checkout') {
        echo "Ensure the pipeline is configured to clean the Jenkins workspace before checkout"
        git branch: 'main', changelog: false, poll: false, url: 'https://github.com/akilagithub/OracleTechVersant.git'
    }
}
node('oracleapps'){
    
    stage ('Code Analysis') {
   // sleep 30
       /* echo "Migrating the project to a cleaned CI database; Running Code Analysis for Oracle; Checking for Invalid Objects"
            withEnv(["JAVA_HOME=$JavaHome"]) {      
                  withSonarQubeEnv("SonarCloud") {
                     sh "${tool("SonarScanner")}/bin/sonar-scanner"
                  }
            }*/
 withCredentials([usernamePassword(credentialsId: 'SONAR', passwordVariable: 'PASSWORD', usernameVariable: 'USERNAME')]){
    withSonarQubeEnv('SonarQube') {
                println('Sonar Method enter');
		sh '''
		cd /data/apps/fs1/EBSapps/appl/po/12.0.0/workspace/OraclePipeline/OracleTechVersant
				//def scannerHome = tool 'Sonar Scanner';
				sh sonar-scanner -Dsonar.login=$USERNAME -Dsonar.password=$PASSWORD";
                echo "Access the SonarQube URL from the Platform Dashboard tile"
		'''              
				}
    
}
    }
     
    stage ('Unit Tests') {
    sleep 40
        echo "Running utPLSQL database Unit Tests"
      
    }

    stage ('copying form to APPS TOP') {
        echo "Copying fmb from cloned location to respective top location"
        sleep 20
        sh '''
           cp /data/apps/fs1/EBSapps/appl/po/12.0.0/workspace/OraclePipeline/OracleTechVersant/EMP11183.fmb /data/apps/fs1/EBSapps/appl/au/12.0.0/forms/US/EMP11183.fmb
           
        '''
    }
    
    stage ('Setting environment') {
        echo "setting environment variable"
        sleep 20
        try{
        sh '''
        cd /data/apps
        ./Casestudyapps.env
        cd /data/apps/fs1/EBSapps/appl
        ls *.env
        echo "Added new line"
        pwd
        source /data/apps/fs1/EBSapps/appl/APPSVIS135_ip-172-31-43-135.env
        source /data/apps/fs1/EBSapps/appl/VIS135_ip-172-31-43-135.env
        echo hello
        echo $?
        frmcmp_batch module=/data/apps/fs1/EBSapps/appl/au/12.0.0/forms/US/EMP11183.fmb userid=apps/clone@VIS135 output_file=/data/apps/fs1/EBSapps/appl/po/12.0.0/forms/US/EMP11183.fmx module_type=FORM compile_all=special batch=yes
        echo demo
        echo $?
        '''
        } catch(Exception e){
            sh '''
            echo demo1
            '''
        }
        
    }
    stage ('Compile Form') {
        sh '''
        echo "Compiling the employee form"
       
        '''   

   }
     
 
     
    stage ('Approval Gate'){
        def message = "Approve release to Production?"
 	
        // wrapping in a time out so it does not block the agent and simply fails the build if there is no user intervention.
        timeout(time: 30, unit: 'MINUTES') {
            def userInput = input(
                id: 'userInput',
                message: "$message",
                parameters: [
                  [$class: 'TextParameterDefinition', defaultValue: 'I Approve The Deployment', description: 'To Proceed, type I Approve The Deployment', name: 'Review deployment artifacts before proceeding']
                ]
            )
 
            if (userInput.indexOf('I Approve The Deployment') == -1) {
                currentBuild.result = 'ABORTED'
                error('Deployment aborted')
            }
        }
    }
     
    stage ('Deploy to Production') {
        echo "Deploying release to Production database"
        sleep 30
 
    }
}
